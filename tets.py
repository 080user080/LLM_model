from transformers import pipeline

# 1. Визначення моделі та токенізатора
MODEL_NAME = "ukr-detect/ukr-emotions-classifier"

# 2. Створення словника для перекладу англійських міток на українські
EMOTION_MAP = {
    'Joy': 'Радість',
    'Anger': 'Злість',
    'Fear': 'Страх',
    'Disgust': 'Огида',
    'Surprise': 'Здивування',
    'Sadness': 'Смуток',
    'None': 'Немає емоції'
}

# 3. Визначення тегів для емоцій (згідно з вашим запитом)
TAGS = {
    'Fear': '#heart',  # Прямий сигнал для напруженої сцени (страх)
    'Anger': '#v'      # Прямий сигнал для злості
}

# 4. Створення пайплайну класифікатора
try:
    classifier = pipeline(
        "text-classification",
        model=MODEL_NAME,
        tokenizer=MODEL_NAME,
        top_k=None  # Повертає бали для всіх міток
    )
except Exception as e:
    print(f"❌ Помилка завантаження моделі. Перевірте підключення до Інтернету або назву моделі: {e}")
    exit()

# 5. Приклад речення для аналізу
# Залиште тут ваш останній приклад для перевірки Огиди
text_to_analyze = "Троуер здивувався, виявив, що він не мертвий. Він лежав на спині на твердій підлозі, накритий щільною тканиною. Голова боліла. Рука боліла ще сильніше. Він пам'ятав, як намагався порізати ту руку, і знав, що йому слід спробувати ще раз, але він просто не міг виплеснути те саме бажання смерті, яке відчував раніше. Навіть пам'ятаючи Відвідувача у вигляді величезної ящірки, навіть пам'ятаючи ці порожні очі, Троуер просто не міг згадати, що це за відчуття. Він знав лише, що це найгірше відчуття у світі."


# ==========================================================
# 6. Запуск класифікації та ПОСТ-ОБРОБКА
# ==========================================================

# 6.1. Запуск класифікації
results = classifier(text_to_analyze)

# 6.2. Визначення словника ключових слів для корекції
correction_keywords = {
    # Додано маркери агресивної ДІЇ та синоніми Злості
    'Anger': ["кипіло", "дратував", "кулак", "злість", "палала", "вдарив", "напружене", "викликом", "роздратування"],
    
    # Додано маркери відчуття та синоніми Огиди
    'Disgust': ["відрази", "відвернутися", "холод у животі", "огидно", "забрудненим", "нудило", "видовища"],
    
    # Ви можете додати сюди інші емоції, які модель плутає (наприклад, Страх)
    'Fear': ["кровотечу", "скло", "уламки", "застрягли", "глибоко", "порізу", "рани", "небезпечно"],
    'Surprise': ["не вірячи", "очам", "зупинився", "перехопило", "незвичним", "неймовірним", "не вкладається"],
}

text_lower = text_to_analyze.lower()
applied_correction = False

# Створюємо словник для зручної модифікації
emotion_scores = {item['label']: item['score'] for item in results[0]}


# 6.3. Перевірка та корекція для кожної цільової емоції
for emotion_label_en, keywords in correction_keywords.items():
    
    # Перевірка наявності ключових слів у тексті
    found_keyword = any(keyword in text_lower for keyword in keywords)
    
    if found_keyword:
        applied_correction = True
        print(f"\n--- Виявлено ключові слова для {EMOTION_MAP.get(emotion_label_en, emotion_label_en)}. Застосовується корекція. ---")
        
        # Якщо модель дала низький бал (менше 50%)
        if emotion_scores.get(emotion_label_en, 0.0) < 0.5:
            # Штучно встановлюємо високий бал для цільової емоції
            emotion_scores[emotion_label_en] = 0.95 
            
            # Знижуємо бал "Смутку", оскільки модель часто плутає негативні емоції з Sadness
            if emotion_scores.get('Sadness', 0.0) > 0.5:
                 emotion_scores['Sadness'] = 0.2
            
            # Знижуємо бал "Немає емоції"
            if emotion_scores.get('None', 0.0) > 0.5:
                emotion_scores['None'] = 0.1
            

# 6.4. Оновлення результатів для виведення
if applied_correction:
    results[0] = [{'label': label, 'score': score} for label, score in emotion_scores.items()]
    
# Сортуємо результати незалежно від того, чи була корекція
sorted_emotions = sorted(results[0], key=lambda x: x['score'], reverse=True)


# ==========================================================
# 7. Обробка та виведення результатів
# ==========================================================
print("==============================================")
print(f"Аналізований текст: '{text_to_analyze}'\n")
print("Знайдені емоції:")
print("==============================================")

THRESHOLD = 0.0 # Виводимо всі бали, щоб побачити ефект корекції

found_emotions_count = 0

for emotion in sorted_emotions:
    label_en = emotion['label']
    score = emotion['score']
    
    # Виводимо всі емоції, оскільки THRESHOLD = 0.0
    if score >= THRESHOLD:
        found_emotions_count += 1
        label_ukr = EMOTION_MAP.get(label_en, label_en) # Отримання української назви
        tag = TAGS.get(label_en, '') # Отримання відповідного тегу
        
        # Виведення результату в консоль українською мовою
        print(f"  Емоція: **{label_ukr}** | Ймовірність: **{score:.4f}** {tag}")

print("==============================================")