Вставити в кінці речення, визначеного NLP (sentence-boundary detection) — надійніше ніж просто знаки пунктуації для складних текстів.

Вставляти лише якщо наступ/попередній контекст відповідає умовам (lookaround rules, POS, цитати, діалог) — для уникнення хибних спрацьовувань.

Адаптивна вставка на основі confidence + rate-limit (не більше N тегів на абзац/сторінку).


------

Які варіанти складні/вразливі і чому

Вставка «після найближчого розділового знаку» через простий regex — працює для простих випадків. Ламається коли:

пунктуація стоїть з пробілами/переносами (потрібно видаляти зайві пробіли, як ви фіксували),

текст містить діалогні тире, дужки, цитати, абревіатури з крапками, числа (1.5) — тоді простий пошук [.,?!] помилково захопить не ту крапку.

Вставка «всередині збігу» і «граматичні межі» вимагають NLP (розбиття на речення, POS, залежності) для надійності.

-----

Пріоритети і стратегії вирішення конфліктів

Вбудувати confidence і правило вибору: higher confidence wins.

Правило «structural» (precede_line) має вищий пріоритет за inline-rules.

Можливі політики: longest-match, earliest-match, highest-confidence, manual-order.

Рекомендації (без коду, коротко)

Для надійної «після пунктуації» використовувати: знайти пунктуацію, включити її в span і вставити тег після span (ви вже зробили це). Додати крок очищення пробілів перед пунктуацією.

Якщо потрібен «відразу під час збігу» — додати явний режим after_match або before_match.

Для складних мовних меж використовувати sentence tokenizer (nltk/spacy) і вставляти на рівні речення/клауза.

Визначити політику конфліктів (confidence/order) і поріг злиття (thresh).