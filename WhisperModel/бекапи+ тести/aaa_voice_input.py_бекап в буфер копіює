import sounddevice as sd
import numpy as np
from faster_whisper import WhisperModel
import pyautogui
import time
import re
import os
import sys

def llm_function(name, description, parameters):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ñ—É–Ω–∫—Ü—ñ–π"""
    def decorator(func):
        func._is_llm_function = True
        func._function_name = name
        func._description = description
        func._parameters = parameters
        return func
    return decorator

# –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è Whisper –º–æ–¥–µ–ª—ñ (—â–æ–± –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –∫–æ–∂–µ–Ω —Ä–∞–∑)
_whisper_model = None

def get_whisper_model():
    """–û—Ç—Ä–∏–º–∞—Ç–∏ Whisper –º–æ–¥–µ–ª—å (–ª–µ–¥–∞—á–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)"""
    global _whisper_model
    if _whisper_model is None:
        _whisper_model = WhisperModel("medium", device="cuda", compute_type="float16")
    return _whisper_model

def clean_recognized_text(text):
    """–û—á–∏—Å—Ç–∏—Ç–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–∏–π —Ç–µ–∫—Å—Ç –≤—ñ–¥ –∑–∞–π–≤–∏—Ö –ø—Ä–æ–±—ñ–ª—ñ–≤ —Ç–∞ —Å–∏–º–≤–æ–ª—ñ–≤"""
    # –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ non-printable —Å–∏–º–≤–æ–ª–∏, –∞–ª–µ –∑–±–µ—Ä–µ–≥—Ç–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –ª—ñ—Ç–µ—Ä–∏
    text = re.sub(r'[^\x20-\x7E\u0410-\u044F\u0406\u0407\u0456\u0457–Ñ—î–Ü—ñ–á—ó“ê“ë\s.,!?-]', '', text)
    
    # –ó–∞–º—ñ–Ω–∏—Ç–∏ –∫—ñ–ª—å–∫–∞ –ø—Ä–æ–±—ñ–ª—ñ–≤ –Ω–∞ –æ–¥–∏–Ω
    text = re.sub(r'\s+', ' ', text)
    
    # –û–±—Ä—ñ–∑–∞—Ç–∏ –ø—Ä–æ–±—ñ–ª–∏ –Ω–∞ –ø–æ—á–∞—Ç–∫—É —ñ –≤ –∫—ñ–Ω—Ü—ñ
    text = text.strip()
    
    return text

def copy_to_clipboard_windows(text):
    """–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É Windows"""
    try:
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≤–±—É–¥–æ–≤–∞–Ω—É –∫–æ–º–∞–Ω–¥—É Windows –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –≤ –±—É—Ñ–µ—Ä
        import subprocess
        
        # –ú–µ—Ç–æ–¥ 1: —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É clip
        process = subprocess.Popen(['clip'], stdin=subprocess.PIPE, shell=True)
        process.communicate(text.encode('utf-8'))
        
        # –î–∞—Ç–∏ —á–∞—Å –¥–ª—è –æ–±—Ä–æ–±–∫–∏
        time.sleep(0.1)
        return True
    except Exception as e:
        print(f"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É: {e}")
        return False

def copy_to_clipboard_universal(text):
    """–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –º–µ—Ç–æ–¥ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É"""
    try:
        # –°–ø—Ä–æ–±—É—î–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ pyperclip —è–∫—â–æ –≤—ñ–Ω –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π
        try:
            import pyperclip
            pyperclip.copy(text)
            time.sleep(0.1)
            return True
        except ImportError:
            pass
        
        # –î–ª—è Windows —á–µ—Ä–µ–∑ subprocess
        if sys.platform == 'win32':
            return copy_to_clipboard_windows(text)
        
        # –î–ª—è Linux —á–µ—Ä–µ–∑ xclip
        elif sys.platform == 'linux':
            import subprocess
            process = subprocess.Popen(['xclip', '-selection', 'clipboard'], stdin=subprocess.PIPE)
            process.communicate(text.encode('utf-8'))
            time.sleep(0.1)
            return True
        
        # –î–ª—è Mac —á–µ—Ä–µ–∑ pbcopy
        elif sys.platform == 'darwin':
            import subprocess
            process = subprocess.Popen(['pbcopy'], stdin=subprocess.PIPE)
            process.communicate(text.encode('utf-8'))
            time.sleep(0.1)
            return True
            
        return False
    except Exception as e:
        print(f"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è: {e}")
        return False

@llm_function(
    name="voice_input",
    description="–∑–∞–ø–∏—Å–∞—Ç–∏ –≥–æ–ª–æ—Å —ñ –≤–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –≤ –∞–∫—Ç–∏–≤–Ω–µ –ø–æ–ª–µ (–±—É–¥—å-—è–∫–∏–π –∫—É—Ä—Å–æ—Ä)",
    parameters={
        "duration": "—Å–∫—ñ–ª—å–∫–∏ —Å–µ–∫—É–Ω–¥ –∑–∞–ø–∏—Å—É–≤–∞—Ç–∏ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 5)"
    }
)
def voice_input(duration="5"):
    """–ì–æ–ª–æ—Å–æ–≤–∏–π –≤–≤—ñ–¥ –≤ –∞–∫—Ç–∏–≤–Ω–µ –ø–æ–ª–µ —á–µ—Ä–µ–∑ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É"""
    try:
        duration = int(duration)
        sample_rate = 16000
        
        print(f"\nüé§ –ì–æ–ª–æ—Å–æ–≤–∏–π –≤–≤—ñ–¥ - –≥–æ–≤–æ—Ä–∏ {duration} —Å–µ–∫—É–Ω–¥...")
        
        # –ó–∞–ø–∏—Å–∞—Ç–∏ –∞—É–¥—ñ–æ
        audio = sd.rec(
            int(duration * sample_rate),
            samplerate=sample_rate,
            channels=1,
            dtype=np.float32,
            blocking=True
        )
        audio = np.squeeze(audio)
        
        print("üîç –†–æ–∑–ø—ñ–∑–Ω–∞—é...")
        
        # –†–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏
        model = get_whisper_model()
        segments, info = model.transcribe(audio, language="uk", beam_size=1)
        
        text = ""
        for seg in segments:
            text += seg.text
        
        if not text.strip():
            return "‚ùå –ù—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ"
        
        # –û—á–∏—Å—Ç–∏—Ç–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–∏–π —Ç–µ–∫—Å—Ç
        cleaned_text = clean_recognized_text(text)
        print(f"üí¨ –†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ: '{cleaned_text}'")
        print(f"üìè –î–æ–≤–∂–∏–Ω–∞: {len(cleaned_text)} —Å–∏–º–≤–æ–ª—ñ–≤")
        print(f"üî§ –°–∏–º–≤–æ–ª–∏: {list(cleaned_text)}")
        print(f"üíæ HEX: {cleaned_text.encode('utf-8').hex()}")
        
        # –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ –≤ –∞–∫—Ç–∏–≤–Ω–µ –ø–æ–ª–µ
        time.sleep(0.5)
        
        # –ö—Ä–æ–∫ 1: –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É
        print("üìã –ö–æ–ø—ñ—é—é –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É...")
        if copy_to_clipboard_universal(cleaned_text):
            print("‚úÖ –¢–µ–∫—Å—Ç —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É")
            
            # –ö—Ä–æ–∫ 2: –í—Å—Ç–∞–≤–∏—Ç–∏ —á–µ—Ä–µ–∑ Ctrl+V
            print("üì§ –í—Å—Ç–∞–≤–ª—è—é —á–µ—Ä–µ–∑ Ctrl+V...")
            
            # –î–≤—ñ —Å–ø—Ä–æ–±–∏ –≤—Å—Ç–∞–≤–∫–∏ –Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –ø–æ–º–∏–ª–∫–∏
            for attempt in range(3):
                try:
                    pyautogui.hotkey('ctrl', 'v')
                    time.sleep(0.2)
                    
                    # –î–æ–¥–∞—Ç–∫–æ–≤–æ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ Enter —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
                    # pyautogui.press('enter')
                    
                    print(f"‚úÖ –£—Å–ø—ñ—à–Ω–æ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ (—Å–ø—Ä–æ–±–∞ {attempt + 1})")
                    break
                except Exception as e:
                    print(f"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ —Å–ø—Ä–æ–±–∞ {attempt + 1}: {e}")
                    time.sleep(0.3)
            
            return f"‚úÖ –í–≤–µ–¥–µ–Ω–æ —Ç–µ–∫—Å—Ç: '{cleaned_text}'"
        else:
            print("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É, –ø—Ä–æ–±—É—é –ø—Ä—è–º–∏–π –≤–≤—ñ–¥...")
            
            # –ó–∞–ø–∞—Å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç - –ø—Ä—è–º–µ –≤–≤–µ–¥–µ–Ω–Ω—è —á–µ—Ä–µ–∑ pyautogui
            try:
                pyautogui.write(cleaned_text, interval=0.02)
                return f"‚ö†Ô∏è –í–≤–µ–¥–µ–Ω–æ —á–µ—Ä–µ–∑ –ø—Ä—è–º–∏–π –≤–≤—ñ–¥ (–º–æ–∂—É—Ç—å –±—É—Ç–∏ –ø–æ–º–∏–ª–∫–∏): '{cleaned_text}'"
            except Exception as e:
                return f"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–≤–æ–¥—É: {str(e)}"
    
    except Exception as e:
        return f"‚ùå –ü–æ–º–∏–ª–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥—É: {str(e)}"