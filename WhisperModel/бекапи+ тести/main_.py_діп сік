import os
import sys
import importlib
import inspect
from pathlib import Path
import time
from colorama import Fore, Back, Style, init

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ colorama
init(autoreset=True)

# –î–æ–¥–∞—Ç–∏ —à–ª—è—Ö–∏ –¥–æ CUDA –±—ñ–±–ª—ñ–æ—Ç–µ–∫
venv_path = sys.prefix
nvidia_paths = [
    os.path.join(venv_path, 'Lib', 'site-packages', 'nvidia', 'cublas', 'bin'),
    os.path.join(venv_path, 'Lib', 'site-packages', 'nvidia', 'cudnn', 'bin'),
    os.path.join(venv_path, 'Lib', 'site-packages', 'nvidia', 'cuda_runtime', 'bin'),
]

for path in nvidia_paths:
    if os.path.exists(path):
        os.environ['PATH'] = path + os.pathsep + os.environ['PATH']
        try:
            os.add_dll_directory(path)
        except:
            pass

import sounddevice as sd
import numpy as np
from faster_whisper import WhisperModel
import requests
import json
import re

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
SAMPLE_RATE = 16000
LISTEN_DURATION = 4  # –°–∫—ñ–ª—å–∫–∏ —Å–ª—É—Ö–∞—Ç–∏ –æ–¥–∏–Ω —Ñ—Ä–∞–≥–º–µ–Ω—Ç
LM_STUDIO_URL = "http://localhost:1234/v1/chat/completions"

# –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –≥—É—á–Ω—ñ—Å—Ç—å –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó
VOLUME_THRESHOLD = 0.01

# –°–ø–∏—Å–æ–∫ —Å–ª—ñ–≤/—Ñ—Ä–∞–∑ –¥–ª—è —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è (–ø–æ–≤–Ω—ñ—Å—Ç—é —ñ–≥–Ω–æ—Ä—É—î–º–æ —Ü—ñ —Ñ—Ä–∞–∑–∏)
IGNORE_PHRASES = {
    # –ü–æ–¥—è–∫–∏
    "–¥—è–∫—É—é", "—Å–ø–∞—Å–∏–±—ñ", "–¥—è–∫—É—é –∑–∞ –ø–µ—Ä–µ–≥–ª—è–¥", "–¥—è–∫—É—é –∑–∞ –ø–µ—Ä–µ–≥–ª—è–¥!",
    "–¥—è–∫—É—é!", "–¥—è–∫—É—é.", "—Å–ø–∞—Å–∏–±—ñ!", "—Å–ø–∞—Å–∏–±—ñ.",
    
    # –ö–æ—Ä–æ—Ç–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    "—Ç–∞–∫", "–Ω—ñ", "–Ω—É", "–∞–≥–∞", "—É–≥—É", "–æ–∫", "–æ–∫–µ–π",
    "—Ç–∞–∫ –æ—Å—å", "–æ—Å—å —Ç–∞–∫", "–æ—Å—å", "—Ü–µ", "—Ö–º", "—Ö–º!",
    
    # –ù–µ –∑—Ä–æ–∑—É–º—ñ–ª–µ
    "–º–∞–∫—Å–∏–º –º–µ–Ω–µ—á–æ–≤—î", "—Ç–µ–º–µ–Ω–∞ –Ω–µ—á–æ–≤—î", "–∑–ª–æ—Å–∏–Ω—å–æ–¥ –Ω–µ–¥–∂—ñ",
    "–Ω–µ –¥—è–∫—É—é", "–∑—Ä–æ–∑—É–º—ñ–≤", "—è—Å–Ω–æ", "–≤—Å–µ", "–≤—Å–µ –≤–æ–Ω–æ",
    
    # –¢–µ—Ö–Ω—ñ—á–Ω—ñ
    "–∑–∞–ª–∏—à—Ç–µ –º—ñ–∫—Ä–æ—Ñ–æ–Ω", "–∑–∞–ª–∏—à—Ç–µ –º—ñ–∫—Ä–æ—Ñ–æ–Ω, —Ç–∞–∫",
}

# –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –¥–æ–≤–∂–∏–Ω–∞ –∫–æ–º–∞–Ω–¥–∏ (—Å–∏–º–≤–æ–ª—ñ–≤ –±–µ–∑ –ø—Ä–æ–±—ñ–ª—ñ–≤)
MIN_COMMAND_LENGTH = 4

# –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è core –º–æ–¥—É–ª—ñ–≤
dispatcher = None
cache_manager = None
streaming_handler = None

class FunctionRegistry:
    """–†–µ—î—Å—Ç—Ä —Ñ—É–Ω–∫—Ü—ñ–π –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º"""
    
    def __init__(self):
        self.functions = {}
        self.core_modules = {}
        self.load_all_modules()
    
    def load_all_modules(self):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å—ñ –º–æ–¥—É–ª—ñ –∑ –ø–∞–ø–∫–∏ functions"""
        functions_dir = Path(__file__).parent / "functions"
        
        if not functions_dir.exists():
            print(f"{Fore.YELLOW}‚ö†Ô∏è  –ü–∞–ø–∫–∞ functions –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞. –°—Ç–≤–æ—Ä—é—é...")
            functions_dir.mkdir()
            (functions_dir / "__init__.py").touch()
            return
        
        # –°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ CORE –º–æ–¥—É–ª—ñ (core_*.py)
        print(f"{Fore.CYAN}üì¶ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è core –º–æ–¥—É–ª—ñ–≤...")
        core_files = sorted(functions_dir.glob("core_*.py"))
        
        for file_path in core_files:
            module_name = file_path.stem
            try:
                spec = importlib.util.spec_from_file_location(module_name, file_path)
                module = importlib.util.module_from_spec(spec)
                spec.loader.exec_module(module)
                
                self.core_modules[module_name] = module
                print(f"{Fore.MAGENTA}‚ö° Core: {Fore.CYAN}{module_name}")
                
                if hasattr(module, 'init'):
                    module.init()
                    
            except Exception as e:
                print(f"{Fore.RED}‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è {module_name}: {e}")
        
        # –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤–∏—á–∞–π–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (aaa_*.py)
        print(f"\n{Fore.CYAN}üì¶ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–π...")
        for file_path in sorted(functions_dir.glob("aaa_*.py")):
            module_name = file_path.stem
            try:
                spec = importlib.util.spec_from_file_location(module_name, file_path)
                module = importlib.util.module_from_spec(spec)
                spec.loader.exec_module(module)
                
                for name, obj in inspect.getmembers(module):
                    if inspect.isfunction(obj) and hasattr(obj, '_is_llm_function'):
                        func_info = {
                            'function': obj,
                            'name': obj._function_name,
                            'description': obj._description,
                            'parameters': obj._parameters
                        }
                        self.functions[obj._function_name] = func_info
                        print(f"{Fore.GREEN}‚úÖ {Fore.CYAN}{obj._function_name}")
            
            except Exception as e:
                print(f"{Fore.RED}‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è {module_name}: {e}")
    
    def get_core_module(self, name):
        """–û—Ç—Ä–∏–º–∞—Ç–∏ core –º–æ–¥—É–ª—å –∑–∞ –Ω–∞–∑–≤–æ—é"""
        for module_name, module in self.core_modules.items():
            if name in module_name:
                return module
        return None
    
    def get_system_prompt(self):
        """–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ system prompt –∑ –æ–ø–∏—Å–æ–º –≤—Å—ñ—Ö —Ñ—É–Ω–∫—Ü—ñ–π"""
        if not self.functions:
            return "–¢–∏ –∫–æ—Ä–∏—Å–Ω–∏–π –∞—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ —ñ–º'—è –ö–ª–∞—Ä–∞. –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é –∫–æ—Ä–æ—Ç–∫–æ —ñ –ø–æ —Å—É—Ç—ñ."
        
        prompt = """–¢–∏ –∫–æ—Ä–∏—Å–Ω–∏–π –∞—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ —ñ–º'—è –ö–ª–∞—Ä–∞. –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é –∫–æ—Ä–æ—Ç–∫–æ —ñ –ø–æ —Å—É—Ç—ñ.

–î–û–°–¢–£–ü–ù–Ü –§–£–ù–ö–¶–Ü–á:
"""
        for func_name, func_info in self.functions.items():
            prompt += f"\n{func_info['name']} - {func_info['description']}\n"
            prompt += "–ü–∞—Ä–∞–º–µ—Ç—Ä–∏:\n"
            for param_name, param_desc in func_info['parameters'].items():
                prompt += f"  - {param_name}: {param_desc}\n"
        
        prompt += """
–í–ê–ñ–õ–ò–í–û! –ö–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—Ä–æ—Å–∏—Ç—å –≤–∏–∫–æ–Ω–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é, –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π –¢–Ü–õ–¨–ö–ò —á–∏—Å—Ç–∏–º JSON:
{"action":"–Ω–∞–∑–≤–∞_—Ñ—É–Ω–∫—Ü—ñ—ó","–ø–∞—Ä–∞–º–µ—Ç—Ä1":"–∑–Ω–∞—á–µ–Ω–Ω—è1","–ø–∞—Ä–∞–º–µ—Ç—Ä2":"–∑–Ω–∞—á–µ–Ω–Ω—è2"}

–ü—Ä–∏–∫–ª–∞–¥: {"action":"create_file","filename":"test.txt","content":"–ü—Ä–∏–≤—ñ—Ç —Å–≤—ñ—Ç"}

–Ø–∫—â–æ —Ü–µ –∑–≤–∏—á–∞–π–Ω–∞ —Ä–æ–∑–º–æ–≤–∞, –ø—Ä–æ—Å—Ç–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π —Ç–µ–∫—Å—Ç–æ–º."""
        
        return prompt
    
    def execute_function(self, action, params):
        """–í–∏–∫–æ–Ω–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é –∑–∞ –Ω–∞–∑–≤–æ—é"""
        if action not in self.functions:
            return f"{Fore.RED}‚ùå –§—É–Ω–∫—Ü—ñ—è {action} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞"
        
        try:
            func = self.functions[action]['function']
            result = func(**params)
            return result
        except Exception as e:
            return f"{Fore.RED}‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è {action}: {str(e)}"

def extract_json_from_text(text):
    """–í–∏—Ç—è–≥—Ç–∏ JSON –∑ —Ç–µ–∫—Å—Ç—É"""
    text = re.sub(r'<\|[^|]+\|>', '', text)
    text = re.sub(r'assistant|channel|commentary.*?(?=\{)|to=functions\.\w+|constrain|message', '', text)
    
    json_match = re.search(r'```json\s*(.*?)\s*```', text, re.DOTALL)
    if json_match:
        return json_match.group(1).strip()
    
    json_match = re.search(r'```\s*(.*?)\s*```', text, re.DOTALL)
    if json_match:
        return json_match.group(1).strip()
    
    json_match = re.search(r'\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}', text, re.DOTALL)
    if json_match:
        return json_match.group(0).strip()
    
    return text.strip()

def ask_llm(user_message, conversation_history, system_prompt):
    """–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞–ø–∏—Ç –¥–æ LM Studio"""
    try:
        messages = [{"role": "system", "content": system_prompt}]
        messages.extend(conversation_history)
        messages.append({"role": "user", "content": user_message})
        
        response = requests.post(LM_STUDIO_URL, 
            json={
                "messages": messages,
                "temperature": 0.3,
                "max_tokens": 1024,
                "stream": False
            },
            timeout=60
        )
        
        if response.status_code == 200:
            return response.json()['choices'][0]['message']['content']
        else:
            return f"–ü–æ–º–∏–ª–∫–∞: {response.status_code}"
    except Exception as e:
        return f"{Fore.RED}‚ùå –ü–æ–º–∏–ª–∫–∞: {str(e)}"

def process_llm_response(response_text, registry):
    """–û–±—Ä–æ–±–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å LLM —ñ –≤–∏–∫–æ–Ω–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó"""
    json_text = extract_json_from_text(response_text)
    
    try:
        response_json = json.loads(json_text)
        
        if "action" in response_json:
            action = response_json.pop("action")
            result = registry.execute_function(action, response_json)
            return result
    except json.JSONDecodeError:
        pass
    
    return response_text

def check_volume(audio):
    """–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —î –∑–≤—É–∫ (–Ω–µ —Ç–∏—à–∞)"""
    return np.abs(audio).mean() > VOLUME_THRESHOLD

def should_ignore_command(text):
    """–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –∫–æ–º–∞–Ω–¥—É –ø–æ—Ç—Ä—ñ–±–Ω–æ —ñ–≥–Ω–æ—Ä—É–≤–∞—Ç–∏"""
    if not text or not text.strip():
        return True
    
    # –û—á–∏—Å—Ç–∏—Ç–∏ —Ç–µ–∫—Å—Ç
    cleaned = text.strip().lower()
    cleaned = re.sub(r'[^\w\s–∞-—è“ë—î—ñ—ó]', '', cleaned, flags=re.IGNORECASE)
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–æ–≤–∂–∏–Ω—É (–±–µ–∑ –ø—Ä–æ–±—ñ–ª—ñ–≤)
    text_without_spaces = re.sub(r'\s+', '', cleaned)
    if len(text_without_spaces) < MIN_COMMAND_LENGTH:
        return True
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —Ü–µ —ñ–≥–Ω–æ—Ä–æ–≤–∞–Ω–∞ —Ñ—Ä–∞–∑–∞
    for phrase in IGNORE_PHRASES:
        phrase_lower = phrase.lower().strip()
        if phrase_lower in cleaned:
            # –Ø–∫—â–æ —Ü–µ –¢–û–ß–ù–û —Ü—è —Ñ—Ä–∞–∑–∞ –∞–±–æ —Ñ—Ä–∞–∑–∞ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è/–∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è —Ü–∏–º
            if cleaned == phrase_lower or \
               cleaned.startswith(phrase_lower + " ") or \
               cleaned.endswith(" " + phrase_lower) or \
               f" {phrase_lower} " in f" {cleaned} ":
                return True
    
    # –Ø–∫—â–æ —Ç–µ–∫—Å—Ç –º—ñ—Å—Ç–∏—Ç—å –ª–∏—à–µ —Ü–∏—Ñ—Ä–∏ –∞–±–æ —Å–∏–º–≤–æ–ª–∏
    if re.match(r'^[\d\s]+$', cleaned):
        return True
    
    return False

class VoiceAssistant:
    def __init__(self, whisper_model, registry, system_prompt):
        self.whisper_model = whisper_model
        self.registry = registry
        self.system_prompt = system_prompt
        self.conversation_history = []
        self.is_listening = True
        self.last_command_time = 0
        self.command_cooldown = 2  # –°–µ–∫—É–Ω–¥ –º—ñ–∂ –∫–æ–º–∞–Ω–¥–∞–º–∏
        
        # –û—Ç—Ä–∏–º–∞—Ç–∏ core –º–æ–¥—É–ª—ñ
        global dispatcher, cache_manager, streaming_handler
        dispatcher_module = registry.get_core_module('dispatcher')
        if dispatcher_module:
            dispatcher = dispatcher_module.Dispatcher(registry)
            print(f"{Fore.MAGENTA}‚ö° –î–∏—Å–ø–µ—Ç—á–µ—Ä –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ")
        
        cache_module = registry.get_core_module('cache')
        if cache_module:
            cache_manager = cache_module.CacheManager()
            print(f"{Fore.MAGENTA}‚ö° –ö–µ—à –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ")
        
        streaming_module = registry.get_core_module('streaming')
        if streaming_module:
            streaming_handler = streaming_module.StreamingHandler(LM_STUDIO_URL)
            print(f"{Fore.MAGENTA}‚ö° –°—Ç—Ä—ñ–º—ñ–Ω–≥ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ")
        
    def listen_continuously(self):
        """–ü–æ—Å—Ç—ñ–π–Ω–æ —Å–ª—É—Ö–∞—Ç–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω"""
        print(f"\n{Back.CYAN}{Fore.BLACK} üéß –†–ï–ñ–ò–ú –ü–†–û–°–õ–£–•–û–í–£–í–ê–ù–ù–Ø {Style.RESET_ALL}")
        print(f"{Fore.YELLOW}üí° –ì–æ–≤–æ—Ä—ñ—Ç—å –∫–æ–º–∞–Ω–¥–∏. –ö–æ—Ä–æ—Ç–∫—ñ —Å–ª–æ–≤–∞ —ñ –ø–æ–¥—è–∫–∏ —ñ–≥–Ω–æ—Ä—É—é—Ç—å—Å—è.")
        print(f"{Fore.YELLOW}üí° –ü—Ä–∏–∫–ª–∞–¥: '–≤—ñ–¥–∫—Ä–∏–π –±–ª–æ–∫–Ω–æ—Ç', '–∑–∞–ø—É—Å—Ç–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä'")
        print(f"{Fore.LIGHTBLACK_EX}üí° Ctrl+C –¥–ª—è –≤–∏—Ö–æ–¥—É\n")
        
        while self.is_listening:
            try:
                # –ó–∞–ø–∏—Å–∞—Ç–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç
                audio = sd.rec(
                    int(LISTEN_DURATION * SAMPLE_RATE),
                    samplerate=SAMPLE_RATE,
                    channels=1,
                    dtype=np.float32,
                    blocking=True
                )
                audio = np.squeeze(audio)
                
                # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —î –∑–≤—É–∫ (–∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ —Ç–∏—à—ñ)
                if not check_volume(audio):
                    continue
                
                # –†–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏
                segments, info = self.whisper_model.transcribe(
                    audio,
                    language="uk",
                    beam_size=1,
                    vad_filter=True
                )
                
                text = ""
                for seg in segments:
                    text += seg.text
                
                if not text.strip():
                    continue
                
                # –ü–æ–∫–∞–∑–∞—Ç–∏ —â–æ –ø–æ—á—É–ª–∏
                print(f"{Fore.LIGHTBLACK_EX}üîâ {text}")
                
                # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –Ω–µ —ñ–≥–Ω–æ—Ä—É–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥—É
                if should_ignore_command(text):
                    print(f"{Fore.LIGHTBLACK_EX}‚è≠Ô∏è  –Ü–≥–Ω–æ—Ä–æ–≤–∞–Ω–æ (—Ñ—ñ–ª—å—Ç—Ä)")
                    continue
                
                # –ö—É–ª–¥–∞—É–Ω –º—ñ–∂ –∫–æ–º–∞–Ω–¥–∞–º–∏
                current_time = time.time()
                if current_time - self.last_command_time < self.command_cooldown:
                    print(f"{Fore.LIGHTBLACK_EX}‚è≠Ô∏è  –ó–∞–Ω–∞–¥—Ç–æ —à–≤–∏–¥–∫–æ, —á–µ–∫–∞—é...")
                    continue
                
                # –û–±—Ä–æ–±–∏—Ç–∏ –∫–æ–º–∞–Ω–¥—É
                print(f"\n{Back.GREEN}{Fore.BLACK} ‚ú® –û–ë–†–û–ë–ö–ê –ö–û–ú–ê–ù–î–ò {Style.RESET_ALL}")
                print(f"{Fore.BLUE}üí¨ [–ö–æ–º–∞–Ω–¥–∞]: {Fore.WHITE}{text}")
                
                self.last_command_time = current_time
                self.process_command(text)
                
                print(f"\n{Fore.CYAN}üéß –ü—Ä–æ–¥–æ–≤–∂—É—é —Å–ª—É—Ö–∞—Ç–∏...\n")
                
            except KeyboardInterrupt:
                print(f"\n\n{Fore.YELLOW}üëã –í–∏–º–∏–∫–∞—é—Å—å...")
                self.is_listening = False
                break
            except Exception as e:
                print(f"{Fore.RED}‚ùå –ü–æ–º–∏–ª–∫–∞: {e}")
                time.sleep(0.5)
    
    def process_command(self, command_text):
        """–û–±—Ä–æ–±–∏—Ç–∏ –∫–æ–º–∞–Ω–¥—É"""
        try:
            start_total = time.time()
            
            # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–µ—à—É
            if cache_manager:
                cached_result = cache_manager.get(command_text)
                if cached_result:
                    print(f"{Fore.YELLOW}‚ö° [–ö–µ—à]")
                    print(f"{Fore.GREEN}ü§ñ [–ö–ª–∞—Ä–∞]: {Fore.WHITE}{cached_result}")
                    print(f"{Fore.LIGHTBLACK_EX}‚è±Ô∏è  0.00—Å")
                    return
            
            # –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —à–≤–∏–¥–∫–∏–π –º–∞—Ä—à—Ä—É—Ç
            if dispatcher:
                quick_result = dispatcher.try_quick_route(command_text)
                if quick_result:
                    elapsed = time.time() - start_total
                    print(f"{Fore.YELLOW}‚ö° [–®–≤–∏–¥–∫–∏–π –º–∞—Ä—à—Ä—É—Ç]")
                    print(f"{Fore.GREEN}ü§ñ [–ö–ª–∞—Ä–∞]: {Fore.WHITE}{quick_result}")
                    print(f"{Fore.LIGHTBLACK_EX}‚è±Ô∏è  {elapsed:.2f}—Å")
                    
                    if cache_manager:
                        cache_manager.set(command_text, quick_result)
                    return
            
            # –ó–≤–∏—á–∞–π–Ω–∏–π LLM –º–∞—Ä—à—Ä—É—Ç
            self.conversation_history.append({"role": "user", "content": command_text})
            
            print(f"{Fore.MAGENTA}ü§î [–î—É–º–∞—é...]")
            start_llm = time.time()
            
            answer = ask_llm(command_text, self.conversation_history, self.system_prompt)
            llm_time = time.time() - start_llm
            
            final_answer = process_llm_response(answer, self.registry)
            
            self.conversation_history.append({"role": "assistant", "content": answer})
            
            if cache_manager and not answer.startswith("{"):
                cache_manager.set(command_text, final_answer)
            
            elapsed = time.time() - start_total
            print(f"{Fore.GREEN}ü§ñ [–ö–ª–∞—Ä–∞]: {Fore.WHITE}{final_answer}")
            print(f"{Fore.LIGHTBLACK_EX}‚è±Ô∏è  {elapsed:.2f}—Å (LLM: {llm_time:.2f}—Å)")
            
            if len(self.conversation_history) > 10:
                self.conversation_history = self.conversation_history[-10:]
                
        except Exception as e:
            print(f"{Fore.RED}‚ùå –ü–æ–º–∏–ª–∫–∞: {e}")

# ==================== –ì–û–õ–û–í–ù–ê –ü–†–û–ì–†–ê–ú–ê ====================

print(f"{Back.BLUE}{Fore.WHITE}{'='*60}")
print(f"{Back.BLUE}{Fore.WHITE}ü§ñ –ö–õ–ê–†–ê - –ì–æ–ª–æ—Å–æ–≤–∏–π –ê—Å–∏—Å—Ç–µ–Ω—Ç (–ë–ï–ó –ê–ö–¢–ò–í–ê–¶–Ü–ô–ù–û–ì–û –°–õ–û–í–ê){Style.RESET_ALL}")
print(f"{Back.BLUE}{Fore.WHITE}{'='*60}{Style.RESET_ALL}")

print(f"\n{Fore.CYAN}üîß –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥—É–ª—ñ–≤...")
start_time = time.time()
registry = FunctionRegistry()
load_time = time.time() - start_time
print(f"{Fore.LIGHTBLACK_EX}‚è±Ô∏è  {load_time:.2f}—Å")

print(f"\n{Fore.CYAN}üé§ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è Whisper...")
start_time = time.time()
whisper_model = WhisperModel("medium", device="cuda", compute_type="float16")
whisper_time = time.time() - start_time
print(f"{Fore.LIGHTBLACK_EX}‚è±Ô∏è  {whisper_time:.2f}—Å")

print(f"\n{Fore.CYAN}üîå –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ LM Studio...")
try:
    test_response = requests.get("http://localhost:1234/v1/models", timeout=5)
    if test_response.status_code == 200:
        models = test_response.json()
        print(f"{Fore.GREEN}‚úÖ {Fore.YELLOW}{models['data'][0]['id']}")
    else:
        print(f"{Fore.YELLOW}‚ö†Ô∏è  –ü—Ä–æ–±–ª–µ–º–∏ –∑ API")
except:
    print(f"{Fore.RED}‚ùå LM Studio –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π!")
    exit()

print(f"\n{Fore.YELLOW}{'='*60}")
print(f"{Fore.YELLOW}üì¶ –§—É–Ω–∫—Ü—ñ–π: {Fore.WHITE}{len(registry.functions)}")
for func_name in registry.functions.keys():
    print(f"{Fore.CYAN}   ‚Ä¢ {func_name}")
print(f"{Fore.YELLOW}{'='*60}{Style.RESET_ALL}")

print(f"\n{Fore.MAGENTA}üìù –§—ñ–ª—å—Ç—Ä–∏:")
print(f"{Fore.CYAN}   ‚Ä¢ –Ü–≥–Ω–æ—Ä—É—î —Å–ª–æ–≤–∞ –∫–æ—Ä–æ—Ç—à—ñ –∑–∞ {MIN_COMMAND_LENGTH} —Å–∏–º–≤–æ–ª—ñ–≤")
print(f"{Fore.CYAN}   ‚Ä¢ –Ü–≥–Ω–æ—Ä—É—î {len(IGNORE_PHRASES)} —Ñ—Ä–∞–∑ (–¥—è–∫—É—é, —Ç–∞–∫, –Ω—ñ, —Ç–æ—â–æ)")
print(f"{Fore.CYAN}   ‚Ä¢ –ö—É–ª–¥–∞—É–Ω: 2 —Å–µ–∫ –º—ñ–∂ –∫–æ–º–∞–Ω–¥–∞–º–∏")

system_prompt = registry.get_system_prompt()
assistant = VoiceAssistant(whisper_model, registry, system_prompt)
assistant.listen_continuously()