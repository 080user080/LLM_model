# main.py
"""–ì–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫—É"""
import os
import sys
import time
from pathlib import Path
from colorama import Fore, Back, Style, init

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ colorama
init(autoreset=True)

# –î–æ–¥–∞—Ç–∏ —à–ª—è—Ö–∏ –¥–æ CUDA –±—ñ–±–ª—ñ–æ—Ç–µ–∫
venv_path = sys.prefix
nvidia_paths = [
    os.path.join(venv_path, 'Lib', 'site-packages', 'nvidia', 'cublas', 'bin'),
    os.path.join(venv_path, 'Lib', 'site-packages', 'nvidia', 'cudnn', 'bin'),
    os.path.join(venv_path, 'Lib', 'site-packages', 'nvidia', 'cuda_runtime', 'bin'),
]

for path in nvidia_paths:
    if os.path.exists(path):
        os.environ['PATH'] = path + os.pathsep + os.environ['PATH']
        try:
            os.add_dll_directory(path)
        except:
            pass

import sounddevice as sd
import numpy as np
import torch
from transformers import Wav2Vec2BertForCTC, AutoProcessor
import requests

# –Ü–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—ñ–≤
from functions.logic_core import FunctionRegistry
from functions.logic_commands import VoiceAssistant
from functions.logic_audio import should_ignore_command, correct_whisper_text
from functions.config import SAMPLE_RATE, LISTEN_DURATION, VOLUME_THRESHOLD

def load_w2v_model():
    """–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ w2v-bert-uk –º–æ–¥–µ–ª—å"""
    try:
        model_name = 'Yehor/w2v-bert-uk-v2.1'
        device = 'cuda' if torch.cuda.is_available() else 'cpu'
        
        print(f"   üîß –ú–æ–¥–µ–ª—å: {model_name}")
        print(f"   üéØ –ü—Ä–∏—Å—Ç—Ä—ñ–π: {device}")
        
        # –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–æ—Ü–µ—Å–æ—Ä
        processor = AutoProcessor.from_pretrained(model_name)
        
        # –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–æ–¥–µ–ª—å
        model = Wav2Vec2BertForCTC.from_pretrained(model_name)
        model = model.to(device)
        model.eval()
        
        print(f"   ‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞")
        return model, processor, device
        
    except Exception as e:
        print(f"   ‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ: {e}")
        raise

def transcribe_audio(audio, model, processor, device):
    """–¢—Ä–∞–Ω—Å–∫—Ä–∏–±—É–≤–∞—Ç–∏ –∞—É–¥—ñ–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é w2v-bert-uk"""
    try:
        # –ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏ –∞—É–¥—ñ–æ –≤ —Ç–µ–Ω–∑–æ—Ä
        audio_tensor = torch.from_numpy(audio).float()
        
        # –ù–æ—Ä–º–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∞—É–¥—ñ–æ
        if torch.max(torch.abs(audio_tensor)) > 0:
            audio_tensor = audio_tensor / torch.max(torch.abs(audio_tensor))
        
        # –û–±—Ä–æ–±–∏—Ç–∏ –ø—Ä–æ—Ü–µ—Å–æ—Ä–æ–º
        inputs = processor(
            audio_tensor.numpy(), 
            sampling_rate=SAMPLE_RATE, 
            return_tensors="pt",
            padding=True
        )
        
        # –ó–Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –∫–ª—é—á –¥–ª—è –≤–≤–æ–¥—É
        input_key = None
        for key in ['input_values', 'input_features']:
            if key in inputs:
                input_key = key
                break
        
        if not input_key:
            print(f"{Fore.RED}   ‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∫–ª—é—á –¥–ª—è –≤–≤–æ–¥—É")
            return ""
        
        # –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ –ø—Ä–∏—Å—Ç—Ä—ñ–π
        input_data = inputs[input_key].to(device)
        
        # –¢—Ä–∞–Ω—Å–∫—Ä–∏–±—É–≤–∞—Ç–∏
        with torch.no_grad():
            logits = model(input_data).logits
        
        # –î–µ–∫–æ–¥—É–≤–∞—Ç–∏
        predicted_ids = torch.argmax(logits, dim=-1)
        text = processor.batch_decode(predicted_ids)[0]
        
        return text.strip()
        
    except Exception as e:
        print(f"{Fore.RED}   ‚ùå –ü–æ–º–∏–ª–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—ó: {e}")
        return ""

def check_volume(audio):
    """–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —î –∑–≤—É–∫ (–Ω–µ —Ç–∏—à–∞)"""
    return np.abs(audio).mean() > VOLUME_THRESHOLD

def main():
    """–ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –∑–∞–ø—É—Å–∫—É"""
    print(f"{Back.BLUE}{Fore.WHITE}{'='*60}")
    print(f"{Back.BLUE}{Fore.WHITE}ü§ñ –ß—ñ–ø - –ì–æ–ª–æ—Å–æ–≤–∏–π –ê—Å–∏—Å—Ç–µ–Ω—Ç {Style.RESET_ALL}")
    print(f"{Back.BLUE}{Fore.WHITE}{'='*60}{Style.RESET_ALL}")
    
    print(f"\n{Fore.CYAN}üîß –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥—É–ª—ñ–≤...")
    start_time = time.time()
    registry = FunctionRegistry()
    load_time = time.time() - start_time
    print(f"{Fore.LIGHTBLACK_EX}‚è±Ô∏è  {load_time:.2f}—Å")
    
    print(f"\n{Fore.CYAN}üé§ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è w2v-bert-uk...")
    start_time = time.time()
    
    try:
        w2v_model, w2v_processor, device = load_w2v_model()
        w2v_time = time.time() - start_time
        print(f"{Fore.LIGHTBLACK_EX}‚è±Ô∏è  {w2v_time:.2f}—Å")
    except Exception as e:
        print(f"{Fore.RED}‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–æ–¥–µ–ª—å —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–≤–∏")
        print(f"{Fore.RED}   –î–µ—Ç–∞–ª—ñ: {e}")
        return
    
    print(f"\n{Fore.CYAN}üîå –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ LM Studio...")
    try:
        test_response = requests.get("http://localhost:1234/v1/models", timeout=5)
        if test_response.status_code == 200:
            models = test_response.json()
            print(f"{Fore.GREEN}‚úÖ {Fore.YELLOW}{models['data'][0]['id']}")
        else:
            print(f"{Fore.YELLOW}‚ö†Ô∏è  –ü—Ä–æ–±–ª–µ–º–∏ –∑ API")
    except:
        print(f"{Fore.RED}‚ùå LM Studio –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π!")
        return
    
    print(f"\n{Fore.YELLOW}{'='*60}")
    print(f"{Fore.YELLOW}üì¶ –§—É–Ω–∫—Ü—ñ–π: {Fore.WHITE}{len(registry.functions)}")
    for func_name in registry.functions.keys():
        print(f"{Fore.CYAN}   ‚Ä¢ {func_name}")
    print(f"{Fore.YELLOW}{'='*60}{Style.RESET_ALL}")
    
    system_prompt = registry.get_system_prompt()
    assistant = VoiceAssistant(w2v_model, registry, system_prompt)
    
    # –ó–±–µ—Ä–µ–≥—Ç–∏ –º–æ–¥–µ–ª—å —É –∞—Å–∏—Å—Ç–µ–Ω—Ç—ñ –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ —ñ–Ω—à–∏—Ö —Ñ—É–Ω–∫—Ü—ñ—è—Ö
    assistant.w2v_processor = w2v_processor
    assistant.w2v_device = device
    
    # –û—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª —Å–ª—É—Ö–∞–Ω–Ω—è
    print(f"\n{Back.CYAN}{Fore.BLACK} üéß –†–ï–ñ–ò–ú –ü–†–û–°–õ–£–•–û–í–£–í–ê–ù–ù–Ø {Style.RESET_ALL}")
    print(f"{Fore.YELLOW}üí° –ì–æ–≤–æ—Ä—ñ—Ç—å –∫–æ–º–∞–Ω–¥–∏. –ö–æ—Ä–æ—Ç–∫—ñ —Å–ª–æ–≤–∞ —ñ –ø–æ–¥—è–∫–∏ —ñ–≥–Ω–æ—Ä—É—é—Ç—å—Å—è.")
    print(f"{Fore.YELLOW}üí° –ü—Ä–∏–∫–ª–∞–¥: '–≤—ñ–¥–∫—Ä–∏–π –±–ª–æ–∫–Ω–æ—Ç', '–∑–∞–ø—É—Å—Ç–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä'")
    print(f"{Fore.LIGHTBLACK_EX}üí° Ctrl+C –¥–ª—è –≤–∏—Ö–æ–¥—É\n")
    
    while assistant.is_listening:
        try:
            # –ó–∞–ø–∏—Å–∞—Ç–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç
            audio = sd.rec(
                int(LISTEN_DURATION * SAMPLE_RATE),
                samplerate=SAMPLE_RATE,
                channels=1,
                dtype=np.float32,
                blocking=True
            )
            audio = np.squeeze(audio)
            
            # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —î –∑–≤—É–∫
            if not check_volume(audio):
                continue
            
            # –†–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é w2v-bert-uk
            text = transcribe_audio(audio, w2v_model, w2v_processor, device)
            
            if not text:
                continue
            
            # –ü–æ–∫–∞–∑–∞—Ç–∏ —â–æ –ø–æ—á—É–ª–∏
            print(f"{Fore.LIGHTBLACK_EX}üîâ {text}")
            
            # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –Ω–µ —ñ–≥–Ω–æ—Ä—É–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥—É
            if should_ignore_command(text):
                print(f"{Fore.LIGHTBLACK_EX}‚è≠Ô∏è  –Ü–≥–Ω–æ—Ä–æ–≤–∞–Ω–æ (—Ñ—ñ–ª—å—Ç—Ä)")
                continue
            
            # –ö—É–ª–¥–∞—É–Ω –º—ñ–∂ –∫–æ–º–∞–Ω–¥–∞–º–∏
            current_time = time.time()
            if current_time - assistant.last_command_time < assistant.command_cooldown:
                print(f"{Fore.LIGHTBLACK_EX}‚è≠Ô∏è  –ó–∞–Ω–∞–¥—Ç–æ —à–≤–∏–¥–∫–æ, —á–µ–∫–∞—é...")
                continue
            
            # –û–±—Ä–æ–±–∏—Ç–∏ –∫–æ–º–∞–Ω–¥—É
            print(f"\n{Back.GREEN}{Fore.BLACK} ‚ú® –û–ë–†–û–ë–ö–ê –ö–û–ú–ê–ù–î–ò {Style.RESET_ALL}")
            print(f"{Fore.BLUE}üí¨ [–ö–æ–º–∞–Ω–¥–∞]: {Fore.WHITE}{text}")
            
            assistant.last_command_time = current_time
            assistant.process_command(text)
            
            print(f"\n{Fore.CYAN}üéß –ü—Ä–æ–¥–æ–≤–∂—É—é —Å–ª—É—Ö–∞—Ç–∏...\n")
            
        except KeyboardInterrupt:
            print(f"\n\n{Fore.YELLOW}üëã –í–∏–º–∏–∫–∞—é—Å—å...")
            assistant.is_listening = False
            break
        except Exception as e:
            print(f"{Fore.RED}‚ùå –ü–æ–º–∏–ª–∫–∞: {e}")
            time.sleep(0.5)

if __name__ == "__main__":
    main()