Ок, «скелет» системи за вашим документом + відмітка стану у вашому проекті.

Основи (перед правилами)

Нормалізація Unicode/«схожих» латинських символів → Є (040_fix_cyrillic_latin_lookalikes.py)

Нормалізація тире/лапок/пробілів для діалогів → Нема (рекомендую додати окреме правило нормалізації пунктуації)

Порожні рядки / технічні роздільники як межі блоку → Нема

Легенда та метадані

Парсер легенди → Є (050_build_metadata_from_legend.py)

Fallback-збірка alias→#g з «сирих» рядків → Є (049_build_aliases_fallback_from_raw_lines.py)

Збагачення alias із дужок («онучка, сонечко…») → Нема (рекомендую 051_enrich_aliases_from_parenthetical.py)

Підказки/прапорці (напр., first_person_gid) → Є (використовується у 074)

Зберігання статі/ролей з легенди для правил → Частково (є атрибути, але правила їх прямо не читають)

Прямі індикатори мовця

Вставка після репліки: «— … — сказав Олег.» → Є (072_inline_sayer_after_quote.py, з перевіркою роду дієслова)

Вставка перед реплікою: «Олег сказав: — …» → Є (073_leadin_speaker_from_narrative.py)

Вставка із займенником: «— … — сказала вона.» (розв’язання «він/вона» за контекстом/статтю) → Нема

Перевірка узгодження роду (дієслово↔ім’я) → Частково (є у 072, нема у 073)

Звертання (Vocatives)

Виявлення кличного, адресат ≠ мовець → Є (076_vocative_uk_morph.py + 074_pair_lock_from_vocatives_v3.py)

Фільтр «неперсонажних» звертань («Боже», «щоденнику») → Частково (евристично)

Чергування / Пара співрозмовників

Побудова пари (останній явний спікер + звертання) → Є (074_pair_lock_from_vocatives_v3.py)

1-ша особа всередині пари тільки якщо first_person_gid ∈ пара → Є (в 074_pair_lock_from_vocatives_v3.py)

Перша особа / Оповідач

«Я/кажу/відповідаю…» прив’язка до first_person_gid → Є (логіка у 074_pair_lock_from_vocatives_v3.py)

Оповідач (#g1) не має прямих діалогів → Є (069_g1_no_dialog.py)

Демоція помилково призначених #g1 → Є (пост-обробка у improved_logic)

Обмеження / Неможливі мовці

Вимкнення мовця після сцени (приклад: Дідо після прологу) → Є (локальне) (074c_block_g4_after_prologue.py)

Універсальні обмеження за сценою/часом/локацією з легенди → Нема

Межі

Межі сцен (Пролог, Глава N, Епілог) у ctx.metadata → Нема

Межі діалогів (блоки обміну репліками, не тягнути пару через межу) → Нема

Розв’язання займенників (coreference)

«він/вона/той/ця» за найближчими згадками і статтю з легенди → Нема

Конфлікти / Перевірки послідовності

Перевірка «flip»/анти-зубця (виправлення зламаного чергування) → Нема

Валідація узгодженості рішення кількома правилами → Нема (лише пріоритети правил)

Логування та оцінка

Діагностика легенди у лог → Є (001_debug_legend_dump.py)

Порядок правил / зведений лог виконання → Є (виводить improved_logic)

Оцінка покриття/точності (метрики) → Нема

Рекомендований мінімум, щоб “завелося як у документі”

Додати 051_enrich_aliases_from_parenthetical.py (розкладання «онучка, сонечко…» у alias).

Додати правило розв’язання займенників (“він/вона”) з використанням статі з легенди та найближчих згадок.

Додати детектор меж сцен (запис у ctx.metadata["scene"]) і меж діалогів (щоб pair_lock не тягнув через блок).

Додати нормалізацію пунктуації (тире/лапки/nbsp) перед аналізом.

Якщо хочете — згенерую готові 3 файли правил (нормалізація пунктуації, межі сцен, межі діалогів) + зачатки правила для «він/вона» під вашу легенду.


Правила були доповнені і можуть відрізнятися